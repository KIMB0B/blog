---
title: 자취생 커뮤니티와 요리 추천 서비스
date: 2024-08-24T12:53:00
---
# 개발 기간

2024년 1월 25일 ~ 2024년 06월 30일 (약 5개월)

---
# 프로젝트 주제

자취생들의 자취 어려움을 해소하고자 자취생들끼리 팁을 주고 받는 커뮤니티의 장을 웹사이트를 통해 만들고자 하였습니다.

그리고 자취하면서 제일 어려운 오늘 뭘 해먹을지에 대해서 AI에게 도움을 받을 수 있도록 내 냉장고에 있는 식재료들을 넣어놓으면 이 재료들로 만들 수 있는 괜찮은 요리들과 이 요리의 레시피들을 제안받을 수 있는 기능도 추가하였습니다.

---
# 프로젝트 전체 구조

![image](https://gist.github.com/user-attachments/assets/e203c008-ba27-4668-8c04-8f4eef89e8f6)

---
# 내 역할

> Backend 총괄 & 배포 총괄

**설계**
- [[#📝 Backend 구조 설계|Backend 전체 구조 설계]]
- [[#📝 ERD 설계|ERD 설계]]
- [[#📝 패키징 환경 구성|패키징 환경 구성]]
- [[#📝 행정기관 코드 구성|행정기관 코드 구성]]
- [[#📝 사용자 등급 구성|사용자 등급 구성]]

**구현**
- [[#🏗️ 사용자 API 구현|사용자 API 구현]]
	- 회원 CRUD
	- JWT 토큰 발급
	- 문자 본인인증 시스템
- [[#🏗️ 요리 추천 API 구현|요리 추천 API 구현]]
	- 요리 재료 CRUD
	- 요리 추천 AI 시스템
- [[#🏗️ 알림 API 구현|알림 API 구현]]
	- 알림 Code 구성
	- 메시지 생성
- [[#🏗️ 쪽지 API 구현|쪽지 API 구현]]
	- 쪽지 CRUD
	- 답장 기능
	- 읽음 기능
- [[#🏗️ 포인트 API 구현|포인트 API 구현]]
	- 포인트 추가/제거

**배포**
- [[#🌏 AWS 환경 배포|AWS환경 배포]]
	- EC2 인스턴스 설정
	- Elastic IP 설정
	- 무중단 배포
- [[#🌏 이미지 업로드 API 구현|이미지 업로드 API 구현]]
	- AWS S3 스토리지 생성
	- AWS S3와 DB 환경 구성

---
# 📝 Backend 구조 설계

![image](https://gist.github.com/user-attachments/assets/d5ba1f23-8cb1-4eff-b978-b00d4e94c685)

---
# 📝 ERD 설계

![image](https://gist.github.com/user-attachments/assets/4bd09795-253b-4e29-82ec-e9da6433b171)

---
# 📝 패키징 환경 구성

## 프로젝트 Dockerfile 구성

**개선 전**
```Dockerfile
FROM node:latest

COPY . /Project/
WORKDIR /Project/
RUN yarn install

CMD yarn start:dev
```

**개선 후**
```dockerfile
FROM node:latest

COPY ./package.json /Project/
COPY ./yarn.lock /Project/
WORKDIR /Project/
RUN yarn install
COPY . /Project/

CMD yarn start:dev
```
기본적으로 node환경이 깔려있는 컨테이너로부터 작업을 하였습니다.

### Build 실행 시간 개선

>[!error] 문제점
>이전에는 Project의 모든 파일을 copy한 후 모듈을 install하였으나, 이렇게 되면 해당 컨테이너를build할 때 마다 기존 모듈과 변동이 없더라도 모듈을 매번 새로 install해야해서 docker build가 너무 오래걸린다는 문제가 있었습니다.

>[!success] 개선법
>Dockerfile은 위의 줄부터 한줄 한줄씩 이전 Build한 상황과 차이점이 있는지 비교하며 차이점이 있는 줄 부터 작업을 실행한다는 것을 알았습니다.<br><br>이를 이용해 우선 모듈과 관련된 package.json, yarn.lock을 우선 복사해온 뒤 yarn install을 진행하고 그 뒤에 프로젝트의 변경된 모든 파일들을 복사해오도록 순서를 설정하였습니다.<br><br>이 변경을 통해 새로운 모듈이 설치되는 등 이전 Build와 모듈이 다른 상황에만 docker build를 진행할 때 yarn install 과정을 진행하고, 이전 Build와 상황이 동일하다면 yarn install을 진행하지 않아 docker build 시간이 매우 빨라졌습니다.

---
# 📝 행정기관 코드 구성

행정안전부에서 제공한 `행정기관(행정동) 및 관할구역(법정동) 변경내역`에서 프로젝트 시작 시기인 2024년 2월 1일 자료를 받아서 `시/도`, `시/군/구`, `행정동`세 단계로 나누어 Code를 통해 관리하였습니다.

데이터를 받아 우선 Database에 적재할 형태대로 정제하여 CSV파일로 저장했습니다.

데이터 적재는 Docker Compose를 실행시키면서 생기는 Mysql Database에 하였으며, Docker를 실행하여 생성된 Mysql Database 공간에 직접 넣기 위해 따로 코드로 구현한 것이 아닌 DBeaver 프로그램의 `데이터 가져오기` 기능을 통해 적재하였습니다.
<img width="369" alt="image" src="https://gist.github.com/user-attachments/assets/480a6ace-e177-49ea-8ddb-49e89e8fdd38">

>[!note] 아쉬운 점
>직접 외부 프로그램을 통해 CSV파일에서 데이터베이스로 데이터를 넣어줘야 한다는 점이 아쉬웠습니다. 또한 최신 행정동 기준으로 자동 업데이트가 안된다는 점 또한 아쉬웠습니다.<br><br>행정안전부의 가장 최근 행정동 기준 데이터를 자동으로 받아서 이를 데이터베이스에 자동으로 갱신되도록 하는 기능을 적용하는 것으로 개선이 되면 좋을 것 같다고 생각합니다.

---
# 📝 사용자 등급 구성

사용자 등급은 사용자의 point를 통해 정해지는 것이 좋다고 생각하였고, 총 5개의 등급을 구성하였습니다.

| code  | min_point  | max_point |  name  |
| :---: | :--------: | :-------: | :----: |
| admin | -999999999 |    -1     |  관리자   |
|  lv1  |     0      |   1000    | 자취어린이  |
|  lv2  |    1001    |   2000    | 초보자취생  |
|  lv3  |    2001    |   3000    | N년차자취생 |
|  lv4  |    3001    |   4000    |  자취도사  |
|  lv5  |    4001    | 999999999 |  자취만렙  |

가장 고민되었던 것은 관리자를 설정하는 법이었는데, 관리자는 point를 사용할 곳이 없기 때문에 point가 음수라면 관리자가 되도록 설정했습니다.<br>이를 point가 0 이상인 일반 사용자라면 point가 음수가 되지 않도록 설정하였고, 추가적으로 point가 음수인 사용자라면 절대 point가 0 이상이 되지 않도록 코드 내에서 설정하였습니다.

예시)
```typescript
// src/apis/point/point.service.ts

/**
* 포인트 증가 서비스 메서드
* @param user_id 사용자 ID
* @param point 증가할 포인트
* @returns 포인트가 증가된 사용자 정보
*/

async increase(user_id: string, point: number): Promise<User> {

	// 존재하지 않는 사용자에 대한 예외
	const user = await this.userService.findById(user_id);
	if (!user) {
		throw new Error('해당 사용자가 존재하지 않습니다');
	}

	// 관리자인 경우) 포인트 변동 없도록 바로 종료
	const role = await this.findRoleByUserId(user_id);
	if (role.code == 'admin') {
		return user;
	}

	// 일반 사용자이지만 이번 포인트 변동으로 음수가 될 사용자) 음수 대신 0으로 설정하고 종료
	if (user.point + point <= 0) {
		await this.userRepository.update(user_id, { point: 0 });
		return user;
	}

	// 이 외 일반적인 경우) 포인트에 변동을 주고 종료
	await this.userRepository.update(user_id, { point: user.point + point });
	return user;
}
```

>[!success] 해당 구조 장점
>point를 통해 관리자 등급을 설정하도록 설계하니 관리자를 적용하는 것에 매우 간편함을 느꼈습니다.<br><br>처음에는 isAdmin과 같이 boolean타입의 Field를 생성하려 했으나, point는 관리자에게 필요없다는 것을 인지하고 이와 같이 구성하니 관리자 계정을 생성하는 경우에는 그저 point를 -1에서 -999999999 사이의 아무 음수만 넣으면 되는 것이어서 관리자 계정 생성도 간단해졌고, 관리자인지 구별도 간단해졌습니다.

---
#  🏗️ 사용자 API 구현

## 회원 CRUD



---
#  🏗️ 요리 추천 API 구현

## 요리 재료 CRUD

## 요리 추천 AI 시스템
### 명령
```
너는 사용자가 가지고 있는 식재료들에 대한 정보를 JSON으로 받으면, 이 재료들로 혹은 식재료를 더 추가해서 만들 수 있는 요리들의 정보와 레시피를 JSON형태로 반환해주는 요리 추천 봇이야. 

최대 3개까지 요리를 추천할 수 있고, 추천되는 메뉴들이 서로서로 너무 비슷하고 단조롭지 않고 다양하게 추천을 해야해. 너가 반환해야 할 데이터는 요리의 이름과, 사용자가 갖고있는 식재료 중 해당 요리에 사용할 요리 재료들의 항목, 그리고 레시피를 따라 해당 요리를 만들면서 필요한 식재료 중 사용자가 갖고있지 않은 식재료여서 추가적으로 구매해야하는 요리 재료들의 항목, 그리고 요리를 만드는 과정을 한국어로 설명한 걸 배열형태로 보여줘야돼. 그리고 식재료의 이름이나 단위 등등도 kg, ml 같은 단위가 아니면 한국어로 해야해.

과정은 정확히 어떤 요리재료를 얼만큼정도 넣어야 하는지, 몇분만큼 굽거나 끓여야 하는지 등 상세한 과정을 순서대로 해서 적어도 5개 이상의 과정으로 보여줘야해.

json 항목의 이름은 통일해야하는데 우선 recipes라는 배열로 들어가있고, 그다음 요리의 이름은 name, 그리고 사용자가 가지고 있는 요리재료 중 해당 요리에 쓸 재료를 꼭 사용자가 갖고있는 요리재료만으로 구성하여 used_ingredients를 만들어줘, 중요한건 used_ingredients의 개수나 양은 사용자가 현재 갖고 있는 양이 아니고 현재 요리를 만들 때 필요한 재료의 양으로 적어줘야돼. 그리고 사용자가 입력한 사용자가 갖고있는 요리 재료엔 포함되진 않지만 요리를 만들 때는 필요해서 추가적으로 사용자의 구매가 필요한 요리재료는 needed_ingredients로 해야해. 그리고 이 used_ingredients와 needed_ingredients는 배열로 표시해줘야하며 그 안의 요리재료들은 name, volume, volume_unit 형태에 맞춰서 표시해야하고, volume, volume_unit은 해당 요리를 만들면서 필요한 개수나 양을 적어줘 개수면 volume_unit을 '개'로 하면 되고, 나머지는 그에 해당하는 단위를 넣어줘. 그리고 요리 만드는 설명은 instructions로 해야해. 그리고 설명은 앞에 1. 2. 3. 등등 번호를 붙이진 말고 요리를 만드는 순서에 맞게만 넣으면돼.
```

### Assistant 설정
<img width="389" alt="image" src="https://gist.github.com/user-attachments/assets/36c0fad2-7180-4b15-9857-8e7569b3bb5a">

---
#  🏗️ 알림 API 구현

---
#  🏗️ 쪽지 API 구현

---
#  🏗️ 포인트 API 구현

---
# 🌏 AWS 환경 배포

---
# 🌏 이미지 업로드 API 구현
